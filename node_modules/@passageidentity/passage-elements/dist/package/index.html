<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <link rel="icon" href="<%= BASE_URL %>favicon.ico" />
        <title>Passage Local</title>
    </head>
    <style>
        body {
            background: #e5e5e5;
        }

        .container {
            background: transparent;
            margin: 30px auto;
        }

        .profile-container {
            width: 100%;
        }
    </style>
    <body>
        <noscript>
            <strong
                >We're sorry but Passage Local doesn't work properly without JavaScript enabled. Please enable it to
                continue.</strong
            >
        </noscript>
        <select id="theme-toggle" onchange="changeTheme(this)">
            <option value="light">Light Theme</option>
            <option value="dark">Dark Theme</option>
            <option value="auto">Auto Theme</option>
        </select>
        <select id="language-toggle" onchange="changeLocale(this)">
            <option value="auto">Auto</option>
            <option value="en">English</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="es">Spanish</option>
            <option value="pt">Portuguese</option>
            <option value="pl">Polish</option>
            <option value="zh">Chinese</option>
        </select>
        <select id="element-selector" onchange="changeElement(this.value)">
            <option value="passage-auth">Passage Auth</option>
            <option value="passage-login">Passage Login</option>
            <option value="passage-register">Passage Register</option>
        </select>
        <input id="app-id-input" type="text" onchange="changeAppId(this.value)" value="preflight" />
        <div class="container" id="passage-element-container"></div>
        <div class="container profile-container" id="passage-profile-container">
            <!-- <passage-profile app-id="VVpa6Oiji8WRdikYnxbueqRb" default-country-code="us"></passage-profile> -->
        </div>
        <script src="index.umd.js"></script>
        <script>
            // Custom Token Store
            class CustomTokenStore extends Passage.TokenStore {
                async getAuthToken() {
                    const localToken = localStorage.getItem('custom_auth_token');
                    return localToken ?? '';
                }
                async setTokens(authResult) {
                    localStorage.setItem('custom_auth_token', authResult.auth_token);
                    if (authResult.refresh_token) {
                        localStorage.setItem('custom_auth_token', authResult.refresh_token);
                    }
                    return;
                }
                async getRefreshToken() {
                    const refreshToken = localStorage.getItem('custom_refresh_token');
                    return refreshToken ?? undefined;
                }
                async clearTokens() {
                    localStorage.removeItem('custom_auth_token');
                    return;
                }
            }
            const customTokenStore = new CustomTokenStore();

            let appId = 'preflight';
            loadAppId();
            let elementType = 'passage-auth';

            window.onload = renderElements;
            const onSuccess = (data) => {
                console.log('hit onSuccess() in index.html, data:', data);
            };

            const beforeAuth = (data) => {
                console.log('hit beforeAuth() in index.html, data:', data);
                return true;
            };

            const onEvent = (type, data) => {
                console.log('hit onEvent --->', type);
                if (type === 'onLoaded') {
                    // PassageDebug.showDebugPanel();
                    /*PassageDebug.eventHandler.handleEvent({
                        type: 'CreatedUser',
                        payload: { identifier: 'kevin+test@passage.id', identifierType: 'EMAIL' },
                    });*/
                    /*PassageDebug.eventHandler.handleEvent({
                        type: 'FallbackAuthSuccess',
                        payload: { identifier: 'kevin+test@passage.id', authResult: {auth_token: 'Im a token', redirect_url: '/dashboard'} },
                    });*/
                }
            };
            try {
                const PassageUser = window.Passage.PassageUser;
                new PassageUser()
                    .userInfo()
                    .then((value) => console.log('successfully fetched PassageUser.userInfo in index.html:', value));
            } catch {
                console.log('No auth token.');
            }

            let theme = localStorage.getItem('elementTheme') ?? 'light';
            document.getElementById('theme-toggle').value = theme;
            function changeTheme(theme) {
                passageAuth.theme = theme.value;
                passageProfile.theme = theme.value;
                theme = theme.value;
                localStorage.setItem('elementTheme', theme);
            }
            function changeLocale(language) {
                if (language.value === 'auto') {
                    passageAuth.lang = undefined;
                    passageProfile.lang = undefined;
                    return;
                }
                passageAuth.lang = language.value;
                passageProfile.lang = language.value;
            }
            function loadAppId() {
                const storedAppId = localStorage.getItem('passage-app-id');
                if (storedAppId) {
                    appId = storedAppId;
                    document.getElementById('app-id-input').value = storedAppId;
                }
            }
            function changeAppId(id) {
                appId = id;
                localStorage.setItem('passage-app-id', id);
                renderElements();
            }

            function changeElement(element) {
                elementType = element;
                renderElement();
            }
            function renderElements() {
                renderElement();
                renderProfile();
            }

            let passageAuth = undefined;
            let passageProfile = undefined;
            function renderElement() {
                const authElem = document.getElementById('passage-element-container');
                switch (elementType) {
                    case 'passage-login':
                        authElem.innerHTML = `<passage-login app-id="${appId}" default-country-code="us" theme="${theme}"></passage-login>`;
                        passageAuth = document.querySelector('passage-login');
                        break;
                    case 'passage-register':
                        authElem.innerHTML = `<passage-register app-id="${appId}" default-country-code="us" theme="${theme}"></passage-register>`;
                        passageAuth = document.querySelector('passage-register');
                        break;
                    case 'passage-auth':
                    default:
                        authElem.innerHTML = `<passage-auth app-id="${appId}" default-country-code="us" theme="${theme}"></passage-auth>`;
                        passageAuth = document.querySelector('passage-auth');
                }

                // Enable this to see an example when onSuccess is set
                // passageAuth.onSuccess = onSuccess;
                // passageAuth.beforeAuth = beforeAuth;
                passageAuth.onEvent = onEvent;

                // Enable this line to see an example of when a custom tokenStore is set
                // passageAuth.tokenStore = customTokenStore;
            }

            function renderProfile() {
                const theme = localStorage.getItem('elementTheme') ?? 'light';
                const locale = localStorage.getItem('locale') ?? undefined;
                const profileElem = document.getElementById('passage-profile-container');
                profileElem.innerHTML = `<passage-profile app-id="${appId}" default-country-code="us" theme="${theme}" lang="${locale}"></passage-profile>`;
                passageProfile = document.querySelector('passage-profile');

                // Enable these two lines to see an example of when a custom tokenStore is set
                // passageProfile = document.querySelector('passage-profile');
                // passageProfile.tokenStore = customTokenStore;
            }
        </script>
        <!-- built files will be auto injected -->
    </body>
</html>
