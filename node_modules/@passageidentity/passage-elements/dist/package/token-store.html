<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <link rel="icon" href="<%= BASE_URL %>favicon.ico" />
        <title>Passage Local</title>
    </head>
    <style>
        body {
            background: #e5e5e5;
        }

        .container {
            background: white;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
            border-radius: 20px;
            width: 360px;
            margin: 30px auto;
        }

        .profile-container {
            width: 100%;
        }
    </style>
    <body>
        <noscript>
            <strong
                >We're sorry but Passage Local doesn't work properly without JavaScript enabled. Please enable it to
                continue.</strong
            >
        </noscript>
        <div class="container" id="passage-element-container"></div>
        <div class="container profile-container" id="passage-profile-container"></div>
        <script src="index.umd.js"></script>
        <script>
            // Custom Token Store
            class CustomTokenStore extends Passage.TokenStore {
                async getAuthToken() {
                    const localToken = localStorage.getItem('custom_auth_token');
                    return localToken ?? '';
                }
                async setTokens(authResult) {
                    localStorage.setItem('custom_auth_token', authResult.auth_token);
                    if (authResult.refresh_token) {
                        localStorage.setItem('custom_auth_token', authResult.refresh_token);
                    }
                    return;
                }
                async getRefreshToken() {
                    const refreshToken = localStorage.getItem('custom_refresh_token');
                    return refreshToken ?? undefined;
                }
                async clearTokens() {
                    localStorage.removeItem('custom_auth_token');
                    return;
                }
            }
            const customTokenStore = new CustomTokenStore();

            let appId = 'preflight';
            loadAppId();
            let elementType = 'passage-auth';

            window.onload = renderElements;

            const onEvent = (type, data) => {
                console.log('hit onEvent() in index.html, type:', type, ' data:', data);
            };
            try {
                const PassageUser = window.Passage.PassageUser;
                new PassageUser()
                    .userInfo()
                    .then((value) => console.log('successfully fetched PassageUser.userInfo in index.html:', value));
            } catch {
                console.log('No auth token.');
            }

            function loadAppId() {
                const storedAppId = localStorage.getItem('passage-app-id');
            }

            function changeAppId(id) {
                appId = id;
                localStorage.setItem('passage-app-id', id);
                renderElements();
            }

            function renderElements() {
                renderElement();
                renderProfile();
            }

            function renderElement() {
                const authElem = document.getElementById('passage-element-container');
                let passageAuth = undefined;
                authElem.innerHTML = `<passage-auth app-id="${appId}" default-country-code="us"></passage-auth>`;
                passageAuth = document.querySelector('passage-auth');

                passageAuth.tokenStore = customTokenStore;
            }

            function renderProfile() {
                const profileElem = document.getElementById('passage-profile-container');
                profileElem.innerHTML = `<passage-profile app-id="${appId}" default-country-code="us"></passage-profile>`;

                passageProfile = document.querySelector('passage-profile');
                passageProfile.tokenStore = customTokenStore;
            }
        </script>
        <!-- built files will be auto injected -->
    </body>
</html>
